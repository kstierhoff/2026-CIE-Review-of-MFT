---
title: "TDR Analysis"
author: "Kevin L. Stierhoff"
date: "`r Sys.Date()`"
output: html_document
---

```{r set-up,echo=F,message=F,warning=F,error=F,include=F}
# Install and load pacman (library management package)
if (!require("pacman")) install.packages("pacman")
if (!require("pak")) install.packages("pak")

# Install and load required packages from CRAN ---------------------------------
pacman::p_load(tidyverse,plotly,lubridate,here,DBI,odbc,
               knitr,DT,fs,oce,sf,mapview,shadowtext,
               patchwork,RSQLite,xts,progress,plotly)

# Install and load required packages from Github -------------------------------
if (!require("atm")) pkg_install("SWFSC/atm")
pacman::p_load_gh("SWFSC/atm")

if (!require("surveyR")) pkg_install("SWFSC/surveyR")
pacman::p_load_gh("SWFSC/surveyR")

# Knitr options
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE,
                      out.width = "90%")

theme_set(theme_bw())
```

```{r user-settings}
# User-specified settings
copy.files   <- F # Copy TDR files
process.rsk  <- T # Process RBR Duet^3^ TDR files (.rsk format)
process.asc  <- T # Process Seabird TDR files (.asc format)
process.tv80 <- T # Process Simrad TV80 data

# Usually F; set T to reprocess all TDR/TV80 files
process.tdr.all   <- F # Process all TDR files 
process.tv80.all  <- F # Process all TV80 files

get.db      <- F # Extract data from trawl database (F for testing)
get.nav     <- F # Download NOAA Ship nav data
save.figs   <- T # Save figures

# Define colors for legend
gear.cols <- c("Nordic" = "red", "MFT" = "blue")
```

# Data preparation

## Import and process trawl haul data

```{r collect-trawl-data}
if (get.db) {
  # Create directory for trawl data
  dir_create(here("Data/Trawl"))
  
  # Source script to collect data from trawl database
  # source(here("Code/collect_trawl_database.R"))
  
  # Configure ODBC connection to TRAWL database
  trawl.con <- DBI::dbConnect(odbc::odbc(),
                              DRIVER="ODBC Driver 18 for SQL Server",
                              Encrypt = "Optional",
                              DATABASE="Trawl",
                              Trusted_Connection= "Yes",
                              SERVER="swc-estrella-s")
  
  # Get haul info
  haul <- dplyr::tbl(trawl.con,"Haul")  %>% dplyr::collect()
  
  # Close database channel
  DBI::dbDisconnect(trawl.con)
  
  # Save database data
  save(haul, file = here::here("Data/Trawl/trawl_data_raw.Rdata"))
  
} else {
  # Load trawl data
  load(here("Data/Trawl/trawl_data_raw.Rdata"))
  
}

# Format haul info
haul <- haul %>% 
  arrange(cruise, ship, haul) %>% 
  mutate(
    netInWaterTime  = ymd_hms(netInWaterTime),
    equilibriumTime = ymd_hms(equilibriumTime),
    haulBackTime    = ymd_hms(haulBackTime),
    netOnDeckTime   = ymd_hms(netOnDeckTime)) %>% 
  mutate(deploymentTime = difftime(equilibriumTime, netInWaterTime, units = "mins"),
         recoveryTime   = difftime(netOnDeckTime, haulBackTime, units = "mins"),
         evolutionTime  = difftime(netOnDeckTime, netInWaterTime, units = "mins")) %>% 
  mutate(season = case_when(
    month(equilibriumTime) < 6 ~ "spring",
    TRUE ~ "summer"))

# Calculate mean latitude, for converting pressure to depth
mean.lat = mean(haul$startLatDecimal, na.rm = T)
```

## Process navigation data

Load nav data collected during surveys 2021-present.

```{r get-nav}
if (get.nav) {
  nav.all <- data.frame()
  
  for (j in dir_ls(here("Data/Nav"), regexp = "*.Rdata")) {
    # j = dir_ls(here("Data/Nav"), regexp = "*.Rdata")[1]
    
    # Load nav data file
    load(j)
    
    # Add cruise name to nav data
    nav <- nav %>% 
      mutate(cruise = str_extract(j, pattern = "\\d{6}"))
    
    # Combine all cruises
    nav.all <- bind_rows(nav.all, nav)
  }
  
  # Convert nav paths to spatial
  nav.paths <- nav.all %>% 
    st_as_sf(coords = c("long","lat"), crs = 4326) %>% 
    group_by(cruise) %>% 
    summarise(do_union = FALSE) %>% 
    st_cast("LINESTRING")
  
  # Save all nav data
  save(nav.all, nav.paths, nav.paths.sf, 
       file = here("Data/Nav/nav-all.rdata"))
} else {
  # Load processed nav data
  load(here("Data/Nav/nav-all.rdata"))
  
}
```

## Process TDR files

### Read and align raw data

```{r process-tdr-files}
if (process.tdr.all) {
  # Create tbl for all TDR data
  tbl.tdr.all <- data.frame()
  
  # Read TDR info file for fixing date/time/etc.
  tdr.info <- read_csv(here("Data/TDR/tdr-info.csv")) %>% 
    mutate(cruise = as.character(cruise))
  
  # For each directory in Data/TDR (grouped by survey)
  for (i in dir_ls(here("Data/TDR"), type = "directory")) {
    # i = dir_ls(here("Data/TDR"), type = "directory")[1]
    tbl.tdr.cruise <- data.frame()
    
    # For each location (Kite/Footrope)
    for (ii in dir_ls(i, type = "directory")) {
      
      # Print update message
      cat("Processing", ii, "\n")
      
      # Create progress bar
      pb <- progress_bar$new(total = length(dir_ls(ii)), 
                             format = "[:bar] :percent :eta",
                             width = 50)
      
      for (iii in dir_ls(ii)){
        
        if (str_detect(tolower(path_ext(iii)),"rsk")) {
          # Extract TDR data from RSK file
          # Read kite TDR file
          rsk.tmp <- read.rsk(iii)
          
          # Create temporary variables
          tdr.filename <- path_file(rsk.tmp@metadata$filename)
          tdr.cruise   <- str_sub(tdr.filename, 1,6)
          tdr.haul     <- as.numeric(str_sub(tdr.filename, 
                                             nchar(tdr.cruise) + 3, 
                                             nchar(tdr.cruise) + 5))
          
          tbl.tmp <- as_tibble(rsk.tmp@data) %>% 
            mutate(filename = tdr.filename,
                   cruise   = tdr.cruise, 
                   haul     = tdr.haul,
                   depth    = surveyR::calc_depth(mean.lat, pressure*100),
                   loc      = ifelse(str_detect(iii, "FR.rsk"), "Footrope", "Kite"))
          
          # Update progress bar
          pb$tick()
          
        } else if (str_detect(tolower(path_ext(iii)),"asc")) {
          # Extract TDR data from ASCII file
        }
        
        # Combine with data from rest of cruise
        tbl.tdr.cruise <- bind_rows(tbl.tdr.cruise, tbl.tmp)
      }
    }
    
    # Save results
    save(tbl.tdr.cruise, file = here(i, paste0(basename(i), "_tdr_raw.Rdata")))
    
    # Combine data from cruise with all data
    tbl.tdr.all <- bind_rows(tbl.tdr.all, tbl.tdr.cruise)
  }
  
  # Save processing results
  save(tbl.tdr.all, file = here("Data/TDR/all_tdr_raw.Rdata"))
  
  # Apply time fix, depth offset, and gear type to TDR data
  tbl.tdr.all <- tbl.tdr.all %>% 
    left_join(tdr.info) %>% 
    mutate(time = force_tz(time, tz = tz),
           time.utc = with_tz(time, tzone = "UTC") +
             years(offset.y) + months(offset.m) + days(offset.d) +
             hours(offset.H) + minutes(offset.M)) %>% 
    mutate(depth = depth + offset.z)  %>% 
    mutate(key = paste(cruise, haul)) %>% 
    left_join(select(haul, cruise, haul, gearType)) %>% 
    arrange(loc, time.utc)
  
  # Save corrected results
  save(tbl.tdr.all, file = here("Data/TDR/all_tdr.Rdata"))
  
} else {
  load(here("Data/TDR/all_tdr.Rdata"))
}
```

### Extract fishing data

```{r extract-fishing-data}
if (process.tdr.all) {
  # Extract data during fishing
  
  # Create df for storing TDR data
  tdr.fishing <- data.frame()
  
  # Extract fishing data
  for (i in unique(tbl.tdr.all$key)) {
    # Get haul info
    haul.tmp <- haul %>%
      mutate(key = paste(cruise, haul)) %>% 
      filter(key == i)
    
    # Subset TDR data and extract fishing data
    tdr.tmp <- tbl.tdr.all %>%
      filter(key == i) %>% 
      filter(between(time.utc, haul.tmp$equilibriumTime, haul.tmp$haulBackTime)) %>% 
      select(cruise, haul, time.utc, loc, depth)
    
    if ("Kite" %in% tdr.tmp$loc & "Footrope" %in% tdr.tmp$loc) {
      # For hauls that have both kite and footrope TDRs
      # Calculate relative time from start of fishing
      tdr.tmp <- tdr.tmp %>% 
        pivot_wider(names_from = loc, values_from = depth) %>% 
        mutate(time.diff = c(0, diff(time.utc)),
               time.cum  = cumsum(time.diff)/60,
               height = Kite - Footrope) %>% 
        mutate(key = i)
      
      # Combine results
      tdr.fishing <- bind_rows(tdr.tmp, tdr.fishing)
    }
  }
  
  # Arrange TDR data by time
  tdr.fishing <- tdr.fishing %>% 
    arrange(cruise, haul, time.utc) %>% 
    mutate(year = year(time.utc)) %>% 
    # Define gear type
    mutate(gear.type = case_when(
      year > 2023 ~ "MFT",
      TRUE ~ "Nordic"))
  
  # Save processed data
  save(tdr.fishing, file = here("Data/TDR/tdr_data_fishing.Rdata"))
  
} else {
  # Load processed data
  load(here("Data/TDR/tdr_data_fishing.Rdata"))
}
```

```{r extract-tdr-paths}
# Create df for all results
tdr.nav.all <- data.frame()

for (k in unique(tdr.fishing$cruise)) {
  tdr.nav.cruise <- data.frame()
  
  # Subset per cruise
  tdr.sub <- filter(tdr.fishing, cruise == k)
  
  for (kk in unique(tdr.sub$haul)) {
    # kk=4
    # Extract TDR data for each haul
    tdr.tmp <- filter(tdr.sub, haul == kk)
    
    # Extract nav data during the fishing period
    nav.tmp <- filter(nav.all, between(time, min(tdr.tmp$time.utc), max(tdr.tmp$time.utc))) %>% 
      mutate(period = "Fishing",
             cruise = unique(tdr.tmp$cruise),
             haul = kk)    
    
    tdr.nav.cruise <- bind_rows(tdr.nav.cruise, nav.tmp)
  }
  
  tdr.nav.all <- bind_rows(tdr.nav.all, tdr.nav.cruise)
}

tdr.nav.sf <- tdr.nav.all %>% 
  st_as_sf(coords = c("long","lat"), crs = 4326) 

# Identify hauls with >1 point
tdr.nav.summ <- tdr.nav.all %>% 
  group_by(cruise, haul) %>% tally() %>% arrange(n) %>% 
  filter(n > 1) %>% 
  mutate(key = paste(cruise, haul))

tdr.paths.sf <- tdr.nav.sf %>% 
  mutate(key = paste(cruise, haul)) %>% 
  filter(key %in% tdr.nav.summ$key) %>% 
  group_by(cruise, haul, period) %>% 
  summarise(do_union = FALSE) %>% 
  st_cast("LINESTRING") %>% 
  ungroup() %>% 
  mutate(distance = st_length(.)) %>% 
  filter(as.numeric(distance) > 0)
```

### Calculate net metrics

Since the horizontal spread (or semi-major axis, $a$) are not known, the area ($A$) of the net opening is estimated using the following equation for the area of an ellipse:

$$A = \pi b \sqrt{\frac{P^2}{2\pi^2} - b^2}$$ where $P$ is the net perimeter at the mouth opening and $b$ is the semi-minor axis, calculated as half of the vertical opening measured by the TDRs.

The Nordic has an 12 m-high opening and a 28 m-wide opening with a nominal area of 336 m\^2. From that, the perimeter is estimated to be 65.7 m (LITZ ET AL.: NORTHERN ANCHOVY ECOLOGY AND DISTRIBUTION CalCOFI Rep., Vol. 49, 2008).

The MFT has an 18 m-high opening and a 36 m-wide opening with a nominal area of 648 m\^2. From that, the perimeter is estimated to be 87.2 m (S. Melly, Swan Nets, pers. comm).

```{r calculate-net-metrics}
# Calculate horizontal spread and area
tdr.fishing <- tdr.fishing %>% 
  # Calculate spread
  mutate(P = case_when(
    gear.type == "MFT" ~ 87.2,
    gear.type == "Nordic" ~ 65.7,
    TRUE ~ NA
  )) %>% 
  mutate(b = height/2,
         A = pi*b*sqrt((P^2)/(2*pi^2)-b^2)) %>% 
  filter(!is.na(A))
```

```{r summarise-tdr-metrics}
# Summarize TDR depth by location and cruise
tdr.depth.summ.k <- tdr.fishing %>% 
  group_by(cruise) %>% 
  summarise(kite.depth = mean(Kite, na.rm = TRUE)) 

tdr.depth.summ.fr <- tdr.fishing %>% 
  group_by(cruise) %>% 
  summarise(footrope.depth = mean(Footrope, na.rm = TRUE)) 

tdr.depth.summ <- tdr.depth.summ.k %>% 
  left_join(tdr.depth.summ.fr)

# Summarize mouth opening by cruise
tdr.height.summ <- tdr.fishing %>% 
  group_by(cruise) %>% 
  summarise(mean.height = mean(height, na.rm = TRUE))

tdr.area.summ <- tdr.fishing %>% 
  group_by(cruise) %>% 
  summarise(mean.area = mean(A, na.rm = TRUE))

tdr.summ.haul <- tdr.fishing %>% 
  group_by(cruise, haul, gear.type) %>% 
  summarise(mean.area = mean(A, na.rm = TRUE))

# Combine haul summaries with distances to compute volume sampled or swept area
tdr.summ.haul <- tdr.summ.haul %>% 
  left_join(select(tdr.paths.sf, cruise, haul, distance)) %>% 
  mutate(V = mean.area * distance)

# Summarise volume/swept area for histogram plots
tdr.summ.all <- tdr.summ.haul %>% 
  group_by(cruise, gear.type) %>% 
  summarise(mean.d = mean(distance, na.rm = T),
            mean.A = mean(mean.area, na.rm = T),
            mean.V = mean(V, na.rm = T))

```

```{r plot-fishing-data}
if (save.figs) {
  # Save TDR depth plots
  tdr.plot.depths <- ggplot(filter(tdr.fishing, time.cum < 45)) +
    geom_path(aes(time.cum, Kite, group = haul), colour = "red", alpha = 0.1) +
    geom_path(aes(time.cum, Footrope, group = haul), colour = "blue", alpha = 0.1) +
    # geom_hline(data = tdr.depth.summ.k,
    #            aes(yintercept = kite.depth), linetype = "dashed") +
    # geom_hline(data = tdr.depth.summ.fr,
    #            aes(yintercept = footrope.depth), linetype = "dashed") +
    geom_rect(data = tdr.depth.summ,
              aes(xmin = 0,
                  xmax = 45,
                  ymin = footrope.depth,
                  ymax = kite.depth),
              fill = 'gray70', alpha = 0.1) +
    geom_rect(data = tdr.depth.summ,
              aes(xmin = 0,
                  xmax = 45,
                  ymin = footrope.depth,
                  ymax = kite.depth),
              colour = 'black', linetype = "dashed", alpha = 0.5) +
    facet_wrap(~cruise, nrow = 2) + 
    labs(x = "Time fishing (minutes)",
         y = "Depth (m)") +
    theme(strip.background = element_rect(fill = "white"),
          strip.text.x = element_text(face = "bold")) 
  
  ggsave(tdr.plot.depths, 
         filename = here("Figs/fig_tdr_depths_all_facet.png"),
         width = 7, height = 7)
  
  tdr.plot.heights <- ggplot(filter(tdr.fishing, time.cum < 45)) +
    # ggplot(filter(tdr.fishing, time.cum < 45, height > 0)) +
    geom_path(aes(time.cum, height, group = haul), 
              colour = "green", alpha = 0.3) +
    facet_wrap(~cruise, nrow = 2) +
    labs(x = "Time fishing (minutes)",
         y = "Vertical opening (m)") +
    theme(strip.background = element_rect(fill = "white"),
          strip.text.x = element_text(face = "bold")) 
  
  ggsave(tdr.plot.heights, 
         filename = here("Figs/fig_tdr_heights_all_facet.png"),
         width = 7, height = 7)
  
  tdr.plot.area <- ggplot(filter(tdr.fishing, time.cum < 45)) +
    # ggplot(filter(tdr.fishing, time.cum < 45, height > 0)) +
    geom_path(aes(time.cum, A, group = haul), 
              colour = "purple", alpha = 0.3) +
    facet_wrap(~cruise, nrow = 2) +
    labs(x = "Time fishing (minutes)",
         y = "Opening area (m^2)") +
    theme(strip.background = element_rect(fill = "white"),
          strip.text.x = element_text(face = "bold")) 
  
  ggsave(tdr.plot.area, 
         filename = here("Figs/fig_tdr_areas_all_facet.png"),
         width = 7, height = 7)
}
```

```{r plot-tdr-metrics-cruise}
# Plot distance histograms
tdr.plot.distances <- ggplot(tdr.summ.haul, aes(as.numeric(distance), fill = gear.type)) +
  geom_histogram(show.legend = FALSE) +  
  geom_vline(data = tdr.summ.all, aes(xintercept = as.numeric(mean.d)),
             colour = "black", linetype = "dashed", linewidth = 0.5) +
  facet_wrap(~cruise, ncol = 1) + 
  labs(title = "Haul distances",
       x = "Haul distance (m)",
       y = "Frequency") +
  scale_fill_manual(name = "Gear type",
                    values = gear.cols) +
  theme(strip.background = element_rect(fill = "white"),
        strip.text.x = element_text(face = "bold")) 

ggsave(tdr.plot.distances, 
       filename = here("Figs/fig_tdr_distances_all_facet.png"),
       width = 5, height = 7)

# Plot area histograms
tdr.plot.areas <- ggplot(tdr.summ.haul, aes(as.numeric(mean.area), fill = gear.type)) +
  geom_histogram(show.legend = FALSE) + 
  geom_vline(data = tdr.summ.all, aes(xintercept = as.numeric(mean.A)),
             colour = "black", linetype = "dashed", linewidth = 0.5) +
  facet_wrap(~cruise, ncol = 1) + 
  labs(title = "Net area",
       x = "Net area (m^2)",
       y = "Frequency") +
  scale_fill_manual(name = "Gear type",
                    values = gear.cols) +
  theme(strip.background = element_rect(fill = "white"),
        strip.text.x = element_text(face = "bold")) 

ggsave(tdr.plot.areas, 
       filename = here("Figs/fig_tdr_areas_all_facet.png"),
       width = 5, height = 7)

# Plot volume histograms
tdr.plot.volumes <- ggplot(tdr.summ.haul, aes(as.numeric(V), fill = gear.type)) +
  geom_histogram() + 
  geom_vline(data = tdr.summ.all, aes(xintercept = as.numeric(mean.V)), 
             colour = "black", linetype = "dashed", linewidth = 0.5) +
  facet_wrap(~cruise, ncol = 1) + 
  labs(title = "Volume sampled",
       x = "Volume sampled (m^3)",
       y = "Frequency") +
  scale_fill_manual(name = "Gear type",
                    values = gear.cols) +
  theme(strip.background = element_rect(fill = "white"),
        strip.text.x = element_text(face = "bold")) 

ggsave(tdr.plot.volumes, 
       filename = here("Figs/fig_tdr_volumes_all_facet.png"),
       width = 5, height = 7)

# Combine plots
tdr.plot.combo <- tdr.plot.distances + tdr.plot.areas + tdr.plot.volumes

ggsave(tdr.plot.combo, 
       filename = here("Figs/fig_tdr_summary_combo.png"),
       width = 7, height = 7)
```

```{r plot-tdr-metrics-all}
# Plot distance histograms
tdr.plot.distances.all <- ggplot(tdr.summ.haul, 
                                 aes(as.numeric(distance),
                                     group = gear.type, fill = gear.type,
                                     alpha = 0.5)) +
  geom_histogram(position = "identity", show.legend = FALSE) +  
  labs(x = "Haul distance (m)",
       y = "Frequency") +
  scale_fill_manual(name = "Gear type",
                    values = gear.cols) 

ggsave(tdr.plot.distances.all, 
       filename = here("Figs/fig_tdr_distances_all.png"),
       width = 7, height = 7)

# Plot area histograms
tdr.plot.areas.all <- ggplot(tdr.summ.haul, 
                             aes(as.numeric(mean.area),
                                 group = gear.type, fill = gear.type,
                                 alpha = 0.5)) +
  geom_histogram(position = "identity", show.legend = FALSE) +  
  labs(x = "Net area (m^2)",
       y = "Frequency") +
  scale_fill_manual(name = "Gear type",
                    values = gear.cols) 

ggsave(tdr.plot.areas.all, 
       filename = here("Figs/fig_tdr_areas_all.png"),
       width = 7, height = 7)

# Plot volume histograms
tdr.plot.volumes.all <- ggplot(tdr.summ.haul, 
                               aes(as.numeric(V),
                                   group = gear.type, fill = gear.type,
                                   alpha = 0.5)) +
  geom_histogram(position = "identity", show.legend = FALSE) +  
  labs(x = "Volume sampled (m^3)",
       y = "Frequency") +
  scale_fill_manual(name = "Gear type",
                    values = gear.cols) 

ggsave(tdr.plot.volumes.all, 
       filename = here("Figs/fig_tdr_volumes_all.png"),
       width = 7, height = 7)

# Combine plots
tdr.plot.all.combo <- tdr.plot.distances.all + tdr.plot.areas.all + tdr.plot.volumes.all

ggsave(tdr.plot.all.combo, 
       filename = here("Figs/fig_tdr_summary_all_combo.png"),
       width = 7, height = 7)

# Combine both combo plots
tdr.plot.combo.both <- tdr.plot.combo / tdr.plot.all.combo + 
  plot_layout(heights = c(6, 1))

ggsave(tdr.plot.combo.both, 
       filename = here("Figs/fig_tdr_summary_all_combo_both.png"),
       width = 7, height = 7)
```

### Compare net metrics
#### Net height

```{r aov-height,eval=TRUE}
saveRDS(tdr.fishing,   file = here("Output/tdr_fishing.rds"))
saveRDS(tdr.summ.haul, file = here("Output/tdr_summary.rds"))
# save(tdr.fishing, tdr.summ.haul, file = here("Output/tdr_for_statistics.Rdata"))

# aov.height <- aov(height ~ as.factor(cruise), data = tdr.fishing)
# 
# summary(aov.height)
# 
# plot(TukeyHSD(aov.height))

ggplot(tdr.fishing, aes(cruise, height, fill = gear.type)) + 
  geom_boxplot() +
  labs(x = "Cruise", y = "Height (m)") +
  scale_fill_manual(name = "Gear type",
                    values = gear.cols) 
```

#### Distances

```{r,eval=TRUE}
ggplot(tdr.summ.haul, aes(cruise, as.numeric(distance), fill = gear.type)) + 
  geom_boxplot() +
  scale_fill_manual(name = "Gear type",
                    values = gear.cols) +
  labs(x = "Cruise", y = "Distance (m)")
```

#### Areas

```{r,eval=TRUE}
ggplot(tdr.summ.haul, aes(cruise, as.numeric(mean.area), fill = gear.type)) + 
  geom_boxplot() +
  scale_fill_manual(name = "Gear type",
                    values = gear.cols) +
  labs(x = "Cruise", y = "Area (m^2)")
```

#### Swept area

```{r,eval=TRUE}
ggplot(tdr.summ.haul, aes(cruise, as.numeric(V), fill = gear.type)) + 
  geom_boxplot() +
  scale_fill_manual(name = "Gear type",
                    values = gear.cols) +
  labs(x = "Cruise", y = "Volume sampled (m^3)")
```

# Results

## TDR metrics summary

```{r net-metric-summary}
# Print summary table
kable(tdr.fishing %>% group_by(cruise) %>% 
        summarise(P = mean(P, na.rm=T),
                  b = mean(b, na.rm=T), 
                  W = mean(b*2, na.rm=T), 
                  A = mean(A, na.rm = T)))
```

## Net depths

```{r}
include_graphics(here("Figs/fig_tdr_depths_all_facet.png"))
```

## Net heights

```{r}
include_graphics(here("Figs/fig_tdr_heights_all_facet.png"))
```

## Net metric summary

```{r}
include_graphics(here("Figs/fig_tdr_summary_all_combo_both.png"))
```

# Unused code

```{r debug-tdr-times,eval=FALSE}
# # Define gear type
# tdr.fishing <- tdr.fishing %>% 
#   mutate(gear.type = case_when(
#     cruise %in% c("202407, 202506") ~ "MFT",
#     TRUE ~ "Nordic"
#   ))

# # # Subset tdr.fishing per cruise
# tdr.fishing.sub <- filter(tdr.fishing, cruise == "202107")
#  
# tmp.plot <- ggplot(tdr.fishing.sub) +
#   geom_path(aes(time.cum, height, group = haul), colour = "green") +
#   labs(x = "Cumulative time (mins)", y = "Opening height (m)")
# 
# plotly::ggplotly(tmp.plot)
# 
# ggplot(filter(tdr.fishing.sub, haul == 28)) +
#   geom_path(aes(time.cum, Kite, group = haul), colour = "red") +
#   geom_path(aes(time.cum, Footrope, group = haul), colour = "blue") +
#   labs(x = "Cumulative time (mins)", y = "Depth (m)",
#        title = paste("Cruise: ", unique(tdr.fishing.sub$cruise),
#                      "Gear type: ", unique(tdr.fishing.sub$gear.type)))

```

```{r plot-tdr-results, eval=FALSE}
# # Plot results
# tdr.info <- read_csv(here("Data/TDR/tdr-info.csv")) %>% 
#   mutate(cruise = as.character(cruise))

# tdr.plot <- tdr.fishing %>% 
#   filter(cruise == "202107")
# 
# # Get time info for comparison with trawl database
# tdr.summary <- tdr.plot %>%
#   # filter(haul %in% c(28)) %>%
#   group_by(cruise, haul, loc) %>%
#   summarise(min.time = min(time.utc),
#             max.time = max(time.utc)) %>%
#   left_join(select(haul, cruise, haul, netInWaterTime, equilibriumTime)) %>%
#   mutate(time.diff = -difftime(min.time, netInWaterTime, units = "hours"))
# 
# haul.min <- 121
# haul.max <- haul.min + 29
# 
# tdr.plot.sub <- filter(tdr.plot, between(haul, haul.min, haul.max))
# 
# # filter(tdr.plot, haul == 25) %>% group_by(loc) %>% summarise(min.time = min(time.utc))
# 
# # tdr.plot %>% group_by(haul, loc) %>% summarise(min.time = min(time.utc)) %>% 
# #   pivot_wider(names_from = loc, values_from = min.time) %>% 
# #   mutate(diff.time = difftime(Footrope, Kite, units = "mins")) %>% View()
# 
# trawl.window <- haul %>% 
#   filter(between(haul, haul.min, haul.max),
#          cruise %in% unique(tdr.plot$cruise))
# 
# # Plot results
# ggplot() + 
#   geom_hline(yintercept = 0) +
#   geom_path(data = tdr.plot.sub, 
#             aes(time.utc, depth, group = loc, colour = loc)) +
#   geom_rect(data = trawl.window,
#             aes(xmin = equilibriumTime,
#                 xmax = haulBackTime,
#                 ymin = -60,
#                 ymax = 5),
#             fill = 'gray70', alpha = 0.5) +
#   geom_rect(data = trawl.window,
#             aes(xmin = netInWaterTime,
#                 xmax = netOnDeckTime,
#                 ymin = -60,
#                 ymax = 5), fill = NA,
#             colour = 'gray50', linetype = "dashed", alpha = 0.5) +
#   facet_wrap(~haul, scales = "free", nrow = 5, ncol = 6) 
```
