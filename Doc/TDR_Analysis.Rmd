---
title: "TDR Analysis"
author: "Kevin L. Stierhoff"
date: "`r Sys.Date()`"
output: html_document
---

```{r set-up,echo=F,message=F,warning=F,error=F,include=F}
# Install and load pacman (library management package)
if (!require("pacman")) install.packages("pacman")
if (!require("pak")) install.packages("pak")

# Install and load required packages from CRAN ---------------------------------
pacman::p_load(tidyverse,plotly,lubridate,here,DBI,odbc,
               knitr,DT,fs,oce,sf,mapview,shadowtext,
               patchwork,RSQLite,xts,progress)

# Install and load required packages from Github -------------------------------
if (!require("atm")) pkg_install("SWFSC/atm")
pacman::p_load_gh("SWFSC/atm")

if (!require("surveyR")) pkg_install("SWFSC/surveyR")
pacman::p_load_gh("SWFSC/surveyR")

# Knitr options
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE,
                      out.width = "90%")

theme_set(theme_bw())
```

```{r user-settings}
# User-specified settings
copy.files   <- T # Copy TDR files
process.rsk  <- T # Process RBR Duet^3^ TDR files (.rsk format)
process.asc  <- T # Process Seabird TDR files (.asc format)
process.tv80 <- T # Process Simrad TV80 data

# Usually F; set T to reprocess all TDR/TV80 files
process.tdr.all   <- T # Process all TDR files 
process.tv80.all  <- T # Process all TV80 files

get.db      <- T # Extract data from trawl database (F for testing)
get.nav     <- T # Download NOAA Ship nav data
```

# Process trawl haul data

```{r collect-trawl-data}
if (get.db) {
  # Create directory for trawl data
  dir_create(here("Data/Trawl"))
  
  # Source script to collect data from trawl database
  # source(here("Code/collect_trawl_database.R"))
  
  # Configure ODBC connection to TRAWL database
  trawl.con <- DBI::dbConnect(odbc::odbc(),
                              DRIVER="ODBC Driver 18 for SQL Server",
                              Encrypt = "Optional",
                              DATABASE="Trawl",
                              Trusted_Connection= "Yes",
                              SERVER="swc-estrella-s")
  
  # Get haul info
  haul <- dplyr::tbl(trawl.con,"Haul")  %>% dplyr::collect()
  
  # Close database channel
  DBI::dbDisconnect(trawl.con)
  
  # Save database data
  save(haul, file = here::here("Data/Trawl/trawl_data_raw.Rdata"))
  
} else {
  # Load trawl data
  load(here("Data/Trawl/trawl_data_raw.Rdata"))
  
}
```

```{r format-trawl-data}
# Source script to format data from trawl database
# source(here("Code/format_trawl_database.R"))

# Format haul info
haul <- haul %>% 
  arrange(cruise, ship, haul) %>% 
  mutate(
    netInWaterTime  = ymd_hms(netInWaterTime),
    equilibriumTime = ymd_hms(equilibriumTime),
    haulBackTime    = ymd_hms(haulBackTime),
    netOnDeckTime   = ymd_hms(netOnDeckTime)) %>% 
  mutate(deploymentTime = difftime(equilibriumTime, netInWaterTime, units = "mins"),
         recoveryTime   = difftime(netOnDeckTime, haulBackTime, units = "mins"),
         evolutionTime  = difftime(netOnDeckTime, netInWaterTime, units = "mins")) %>% 
  mutate(season = case_when(
    month(equilibriumTime) < 6 ~ "spring",
    TRUE ~ "summer"))

# Calculate mean latitude, for converting pressure to depth
mean.lat = mean(haul$startLatDecimal, na.rm = T)
```

# Copy TDR data from each survey

Done manually for now. Code below not run.

```{r copy-files, eval=FALSE}
if (copy.files) {
  # Create directory for TDR files -------------------------------------------------  
  dir_create(here("Data/TDR", , c("Kite","Footrope")))
  
  # Copy TDR files
  tdr.files.kite <- dir_ls(file.path(survey.dir[survey.vessel.primary], "DATA/TDR/Kite"),
                           regexp = tdr.pattern)
  file_copy(tdr.files.kite, here("Data/TDR/Kite"), overwrite = TRUE)
  
  tdr.files.foot <- dir_ls(file.path(survey.dir[survey.vessel.primary], "DATA/TDR/Footrope"),
                           regexp = tdr.pattern)
  file_copy(tdr.files.foot, here("Data/TDR/Footrope"), overwrite = TRUE)
  
  # Create directory for TV80 files -------------------------------------------------
  dir_create(here("Data/TV80"))
  
  # Copy TV80 files
  tv80.files <- dir_ls(file.path(survey.dir[survey.vessel.primary], "DATA/TV80"),
                       regexp = "*measurements.csv", recurse = TRUE)
  
  # Copy files where file is empty (size > 0 bytes)
  file_copy(tv80.files[file_info(tv80.files)$size>0], here("Data/TV80"), overwrite = TRUE)
}
```

# Process TDR files

```{r process-tdr-files}
# Create tbl for all TDR data
tbl.tdr.all <- data.frame()

# Read TDR info file for fixing date/time/etc.
tdr.info <- read_csv(here("Data/TDR/tdr-info.csv")) %>% 
  mutate(cruise = as.character(cruise))

# For each directory in Data/TDR (grouped by survey)
for (i in dir_ls(here("Data/TDR"), type = "directory")) {
  # i = dir_ls(here("Data/TDR"), type = "directory")[2]
  tbl.tdr.cruise <- data.frame()
  
  # For each location (Kite/Footrope)
  for (ii in dir_ls(i)) {
    # ii = dir_ls(i, type = "directory", regexp = "Footrope")
    # ii = dir_ls(i, type = "directory", regexp = "Kite") 
    
    # Print update message
    cat("Processing", ii, "\n")
    
    # Create progress bar
    pb <- progress_bar$new(total = length(dir_ls(ii)), 
                           format = "[:bar] :percent :eta",
                           width = 50)
    
    for (iii in dir_ls(ii)){
      # iii = dir_ls(ii)[1]
      
      # # Rename files
      # files_to_rename <- dir_ls(ii) # Lists all TDR files
      # new_names <- stringr::str_replace(files_to_rename, "2307RL", "202307RL")
      # 
      # # Renaming multiple files
      # file_move(path = files_to_rename, new_path = new_names)
      
      if (str_detect(tolower(path_ext(iii)),"rsk")) {
        # Extract TDR data from RSK file
        # Read kite TDR file
        rsk.tmp <- read.rsk(iii)
        
        # Create temporary variables
        tdr.filename <- path_file(rsk.tmp@metadata$filename)
        tdr.cruise   <- str_sub(tdr.filename, 1,6)
        tdr.haul     <- as.numeric(str_sub(tdr.filename, 
                                           nchar(tdr.cruise) + 3, 
                                           nchar(tdr.cruise) + 5))
        
        tbl.tmp <- as_tibble(rsk.tmp@data) %>% 
          mutate(filename = tdr.filename,
                 cruise   = tdr.cruise, 
                 haul     = tdr.haul,
                 depth    = surveyR::calc_depth(mean.lat, pressure*100),
                 loc      = ifelse(str_detect(iii, "FR.rsk"), "Footrope", "Kite"))
        # mutate(time     = force_tz(time, tz = tdr.tz.kite[tdr.haul])) %>% # Define original time
        # # Convert to UTC and apply offset
        # mutate(time     = with_tz(time, tzone = "UTC") + hours(tdr.offset.k[tdr.haul]))
        
        # Update progress bar
        pb$tick()
        
      } else if (str_detect(tolower(path_ext(iii)),"asc")) {
        # Extract TDR data from ASCII file
      }
      
      # Combine with data from rest of cruise
      tbl.tdr.cruise <- bind_rows(tbl.tdr.cruise, tbl.tmp)
      
      # beepr::beep(5)

    }
    # Save results
      save(tbl.tdr.cruise, file = here("Output", paste0(basename(i), "_tdr_raw.Rdata")))
      # tbl.tdr.cruise %>% group_by(cruise, haul, loc) %>% tally() %>% View()
      # tbl.tdr.cruise %>% group_by(cruise, haul) %>% summarise(n_tdrs = n_distinct(loc)) %>% View()
      
      tdr.info <- read_csv(here("Data/TDR/tdr-info.csv")) %>% 
        mutate(cruise = as.character(cruise))
      
      tdr.plot <- tbl.tdr.cruise %>% 
        left_join(tdr.info) %>% 
        mutate(time = force_tz(time, tz = tz),
               time.utc = with_tz(time, tzone = "UTC") +
                 years(offset.y) + months(offset.m) + days(offset.d) +
                 hours(offset.H) + minutes(offset.M)) %>% 
        arrange(loc, time)
      
      tdr.plot %>% 
        filter(haul == 29) %>% 
        group_by(haul,loc) %>% 
        summarise(min.time = min(time.utc),
                  max.time = max(time.utc))
      
      haul.min <- 1
      haul.max <- haul.min + 29
      
      # Plot results
      ggplot(filter(tdr.plot, between(haul, haul.min, haul.max)), 
             aes(time.utc, depth, group = loc, colour = loc)) + 
        geom_path() + facet_wrap(~haul, scales = "free", nrow = 5, ncol = 6)
  }
  
  # Read RSK/ASC files
  ## If ASC file(pre-20xx)
  
  ## If RSK file (20xx-present)
  
  # Combine data from cruise with all data
  tbl.tdr.all <- bind_rows(tbl.tdr.all, tbl.tdr.cruise)
}
```

# Process navigation data

Hold off on this for now.

```{r get-nav, eval=FALSE}
# Source code to get nav data from ERDDAP or SCS
if (nav.source == "ERDDAP") {
  source(here("Code/get_nav_erddap.R"))
} else if (nav.source == "SCS") {
  source(here("Code", scs.nav.script))
}

# Get nav data from Shimada
if (get.nav.sh) {
  source(here("Code/get_nav_erddap_SH.R"))
  
  nav <- bind_rows(nav, nav.sh)
}
```




